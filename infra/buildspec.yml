version: 0.2

# Mãƒ»S CFD App - CodeBuild Terraform Deployment
#
# å¿…è¦ãªç’°å¢ƒå¤‰æ•°:
#   - ENVIRONMENT: dev/staging/prod
#   - AWS_REGION: AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: ap-northeast-1)
#   - PROJECT_NAME: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (ä¾‹: futura)
#   - TF_STATE_BUCKET: Terraform Stateãƒã‚±ãƒƒãƒˆå (äº‹å‰ä½œæˆå¿…é ˆ)

env:
  variables:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "false"

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "ðŸš€ Starting Terraform deployment via CodeBuild"
      - echo "=================================================="

      # Terraformã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - echo "ðŸ“¦ Installing Terraform..."
      - wget -q https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      - unzip -q terraform_1.7.5_linux_amd64.zip
      - mv terraform /usr/local/bin/
      - terraform --version

  pre_build:
    commands:
      - echo "ðŸ” Pre-deployment validation..."
      - cd infra

      # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
      - |
        if [ -z "$ENVIRONMENT" ] || [ -z "$AWS_REGION" ] || [ -z "$PROJECT_NAME" ] || [ -z "$TF_STATE_BUCKET" ]; then
          echo "âŒ ERROR: Missing required environment variables"
          echo "Required: ENVIRONMENT, AWS_REGION, PROJECT_NAME, TF_STATE_BUCKET"
          exit 1
        fi

      - echo "âœ… Environment: $ENVIRONMENT"
      - echo "âœ… Region: $AWS_REGION"
      - echo "âœ… Project: $PROJECT_NAME"
      - echo "âœ… State Bucket: $TF_STATE_BUCKET"

      # AWSèªè¨¼ç¢ºèª
      - echo "ðŸ” Verifying AWS authentication..."
      - aws sts get-caller-identity

      # Terraform Stateãƒã‚±ãƒƒãƒˆå­˜åœ¨ç¢ºèª
      - echo "ðŸª£ Checking Terraform State bucket..."
      - |
        if ! aws s3 ls "s3://$TF_STATE_BUCKET" > /dev/null 2>&1; then
          echo "âŒ ERROR: Terraform State bucket '$TF_STATE_BUCKET' does not exist"
          echo ""
          echo "ðŸ“‹ Please create the state bucket first by running locally:"
          echo "   cd infra"
          echo "   ./setup-backend.sh"
          echo ""
          echo "Then set the bucket name in CodeBuild environment variable TF_STATE_BUCKET"
          exit 1
        fi
      - echo "âœ… State bucket exists"

      # backend.hclç”Ÿæˆ
      - echo "ðŸ“„ Generating backend.hcl..."
      - |
        cat > backend.hcl << EOF
        bucket  = "$TF_STATE_BUCKET"
        key     = "$PROJECT_NAME/$ENVIRONMENT/terraform.tfstate"
        region  = "$AWS_REGION"
        encrypt = true
        EOF
      - cat backend.hcl

      # terraform.tfvarsç”Ÿæˆ
      - echo "ðŸ“„ Generating terraform.tfvars..."
      - |
        cat > terraform.tfvars << EOF
        aws_region   = "$AWS_REGION"
        environment  = "$ENVIRONMENT"
        project_name = "$PROJECT_NAME"
        EOF
      - cat terraform.tfvars

  build:
    commands:
      - echo "ðŸ—ï¸  Starting Terraform deployment..."

      # TerraformåˆæœŸåŒ–
      - echo "âš™ï¸  Initializing Terraform..."
      - terraform init -backend-config=backend.hcl -no-color

      # Terraformãƒ—ãƒ©ãƒ³
      - echo "ðŸ“‹ Creating deployment plan..."
      - terraform plan -out=tfplan -no-color

      # Terraformé©ç”¨
      - echo "ðŸš€ Applying infrastructure changes..."
      - terraform apply -auto-approve tfplan -no-color

  post_build:
    commands:
      - echo "âœ… Deployment completed successfully!"
      - echo ""
      - echo "ðŸ“Š Infrastructure Outputs:"
      - terraform output -no-color
      - echo ""
      - echo "ðŸŽ‰ Deployment finished for environment: $ENVIRONMENT"

      # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      - rm -f tfplan backend.hcl terraform.tfvars

artifacts:
  files:
    - infra/terraform.tfstate
  name: terraform-deployment-$ENVIRONMENT-$(date +%Y%m%d-%H%M%S)
  discard-paths: yes

reports:
  terraform-report:
    files:
      - 'infra/**/*'
    file-format: 'PLAINTEXT'
