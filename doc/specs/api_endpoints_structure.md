# APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ§‹é€ 

## æ¦‚è¦

BTC Mock Appã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ç®¡ç†ç”¨ã¨ä¸€èˆ¬ç”¨ã§æ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `/api/admin/` ä»¥ä¸‹ã«é…ç½®ã•ã‚Œã€ä¸€èˆ¬ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `/api/` ç›´ä¸‹ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ†é¡

### ğŸ” ç®¡ç†ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`/api/admin/`)

ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¾¤ã§ã™ã€‚

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† (`/api/admin/users/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `GET` | `/api/admin/users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾— | `user:read` |
| `POST` | `/api/admin/users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | `user:create` |
| `POST` | `/api/admin/users/{id}/approve` | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ‰¿èª | `profile:approve` |
| `POST` | `/api/admin/users/{id}/reject` | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ‹’å¦ | `profile:approve` |
| `POST` | `/api/admin/users/{id}/activate` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æœ‰åŠ¹åŒ– | `user:update` |
| `POST` | `/api/admin/users/{id}/suspend` | ãƒ¦ãƒ¼ã‚¶ãƒ¼åœæ­¢ | `user:update` |
| `POST` | `/api/admin/users/{id}/delete` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ | `user:delete` |
| `POST` | `/api/admin/users/{id}/reset-password` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | `user:update` |
| `GET` | `/api/admin/users/{id}/balance` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ®‹é«˜å–å¾— | `user:read` |

#### å–å¼•ç®¡ç† (`/api/admin/transactions/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `POST` | `/api/admin/transactions` | å–å¼•ä½œæˆï¼ˆç®¡ç†è€…ã«ã‚ˆã‚‹ï¼‰ | `transaction:create` |

#### å¸‚å ´ãƒ¬ãƒ¼ãƒˆç®¡ç† (`/api/admin/market-rates/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `POST` | `/api/admin/market-rates` | å¸‚å ´ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ»æ›´æ–° | `rate:create` |

### ğŸ‘¤ ä¸€èˆ¬ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`/api/`)

èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ä¸€èˆ¬å…¬é–‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¾¤ã§ã™ã€‚

#### èªè¨¼ (`/api/auth/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `POST` | `/api/auth/login` | ãƒ­ã‚°ã‚¤ãƒ³ | ãªã— |
| `POST` | `/api/auth/logout` | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | `requireAuth` |
| `POST` | `/api/auth/change-password` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ | `requireAuth` |
| `GET` | `/api/auth/me` | ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— | `requireAuth` |

#### ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† (`/api/profile/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `GET` | `/api/profile` | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— | `profile:read` |
| `PUT` | `/api/profile` | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–° | `profile:update` |

#### å–å¼•å±¥æ­´ (`/api/transactions/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `GET` | `/api/transactions` | å–å¼•å±¥æ­´å–å¾—<br/>ï¼ˆç®¡ç†è€…: å…¨ä½“ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼: è‡ªåˆ†ã®ã¿ï¼‰ | `transaction:read` |

#### å¸‚å ´ãƒ¬ãƒ¼ãƒˆå‚ç…§ (`/api/market-rates/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `GET` | `/api/market-rates` | å¸‚å ´ãƒ¬ãƒ¼ãƒˆå±¥æ­´å–å¾— | `requireAuth` |
| `GET` | `/api/market-rates/latest` | æœ€æ–°å¸‚å ´ãƒ¬ãƒ¼ãƒˆå–å¾— | `requireAuth` |

#### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (`/api/upload/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `POST` | `/api/upload/image` | ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | `profile:update` |

#### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (`/api/dashboard/`)

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | æ©Ÿèƒ½ | æ¨©é™ |
|---------|---------------|------|------|
| `GET` | `/api/dashboard` | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾— | `dashboard:access` |

## æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°

### ç®¡ç†è€… (`admin` ã‚°ãƒ«ãƒ¼ãƒ—)

```typescript
permissions: [
  'user:create',
  'user:read', 
  'user:update',
  'user:delete',
  'profile:approve',
  'transaction:create',
  'rate:create',
  'admin:access'
]
```

### ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ (`user` ã‚°ãƒ«ãƒ¼ãƒ—)

```typescript
permissions: [
  'profile:read',
  'profile:update', 
  'transaction:read',
  'dashboard:access'
]
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ†é›¢ã®åˆ©ç‚¹

- **æ˜ç¢ºãªæ¨©é™å¢ƒç•Œ**: ç®¡ç†æ©Ÿèƒ½ã¨ä¸€èˆ¬æ©Ÿèƒ½ã®æ˜ç¢ºãªåˆ†é›¢
- **URLã«ã‚ˆã‚‹è­˜åˆ¥**: ãƒ‘ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒåˆ¤åˆ¥å¯èƒ½
- **ãƒŸã‚¹ã®ãƒªã‚¹ã‚¯ä½æ¸›**: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒªã‚¹ã‚¯ã®è»½æ¸›

### 2. æ¨©é™ãƒã‚§ãƒƒã‚¯

ã™ã¹ã¦ã®ç®¡ç†ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```typescript
// ç®¡ç†ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ¨©é™ãƒã‚§ãƒƒã‚¯ä¾‹
const currentUser = await requirePermission(event, 'required:permission')
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | èª¬æ˜ |
|--------|---------------|------|
| èªè¨¼ã‚¨ãƒ©ãƒ¼ | 401 | ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœªè¨­å®š |
| æ¨©é™ã‚¨ãƒ©ãƒ¼ | 403 | å¿…è¦ãªæ¨©é™ãŒä¸è¶³ |
| ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ | 404 | å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ |
| å…¥åŠ›ã‚¨ãƒ©ãƒ¼ | 400 | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ |

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### ç®¡ç†è€…ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

ç®¡ç†è€…å‘ã‘ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ `/api/admin/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼š

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
await $fetch('/api/admin/users', {
  method: 'POST',
  body: userCreateForm
})

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª
await $fetch(`/api/admin/users/${userId}/approve`, {
  method: 'POST'
})

// å–å¼•ä½œæˆ
await $fetch('/api/admin/transactions', {
  method: 'POST', 
  body: transactionForm
})
```

### ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ `/api/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼š

```typescript
// ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
await $fetch('/api/profile')

// å–å¼•å±¥æ­´å–å¾—
await $fetch('/api/transactions')

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—
await $fetch('/api/dashboard')
```

## ä»Šå¾Œã®æ‹¡å¼µ

### 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

å°†æ¥çš„ã«APIãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆï¼š

```
/api/v1/admin/users
/api/v1/profile
/api/v2/admin/users  # æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
```

### 2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

ç®¡ç†ç”¨ã¨ä¸€èˆ¬ç”¨ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’åˆ†ã‘ã‚‹ã“ã¨ãŒå¯èƒ½ï¼š

```typescript
// ç®¡ç†ç”¨: ã‚ˆã‚Šç·©ã„ãƒ¬ãƒ¼ãƒˆåˆ¶é™
'/api/admin/*': { rateLimit: '1000 per hour' }

// ä¸€èˆ¬ç”¨: ã‚ˆã‚Šå³ã—ã„ãƒ¬ãƒ¼ãƒˆåˆ¶é™  
'/api/*': { rateLimit: '100 per hour' }
```

### 3. ãƒ­ã‚°ãƒ»ç›£æŸ»

ç®¡ç†ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ç‰¹ã«è©³ç´°ãªãƒ­ã‚°ãŒå¿…è¦ï¼š

```typescript
// ç®¡ç†æ“ä½œã®ç›£æŸ»ãƒ­ã‚°
auditLog.record({
  action: 'user:create',
  admin: currentUser.user_id,
  target: newUser.user_id,
  timestamp: now()
})
```

---

ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€æ©Ÿèƒ½ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ˜ç¢ºãªAPIåˆ†é›¢ãŒå®Ÿç¾ã•ã‚Œã€ä¿å®ˆæ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå‘ä¸Šã—ã¦ã„ã¾ã™ã€‚